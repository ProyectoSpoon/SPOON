<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Cache Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            background-color: #F4821F;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #E67812;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow: auto;
            max-height: 400px;
        }
        .log-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
        }
        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .error {
            color: red;
        }
        .success {
            color: green;
        }
        .warning {
            color: orange;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Menu Cache Test</h1>
        <p>This page tests the menu cache functionality to ensure it works correctly.</p>
        
        <div>
            <button id="initCache">Initialize Cache</button>
            <button id="getCache">Get Cache</button>
            <button id="clearCache">Clear Cache</button>
            <button id="testProductosMenu">Test productosMenu</button>
            <button id="testProductosSeleccionados">Test productosSeleccionados</button>
        </div>
        
        <div class="log-container">
            <h3>Log:</h3>
            <div id="log"></div>
        </div>
        
        <div>
            <h3>Cache Data:</h3>
            <pre id="cacheData">No data loaded yet.</pre>
        </div>
    </div>

    <script>
        // Mock localStorage for testing
        const mockStorage = {};
        
        // Mock the menuCache.utils.ts functionality
        const MENU_CACHE_KEY = 'menu_crear_menu';
        const MENU_CACHE_TIME = 1000 * 60 * 30; // 30 minutes
        
        const menuCacheUtils = {
            set: (data) => {
                try {
                    // Ensure productosMenu is always an array
                    if (!Array.isArray(data.productosMenu)) {
                        data.productosMenu = [];
                        log('Warning: productosMenu was not an array. Fixed.', 'warning');
                    }
                    
                    // Ensure productosSeleccionados is always an array
                    if (!Array.isArray(data.productosSeleccionados)) {
                        data.productosSeleccionados = [];
                        log('Warning: productosSeleccionados was not an array. Fixed.', 'warning');
                    }
                    
                    mockStorage[MENU_CACHE_KEY] = JSON.stringify({
                        data: data,
                        timestamp: Date.now()
                    });
                    log('Cache data saved successfully', 'success');
                } catch (error) {
                    log('Error saving cache data: ' + error.message, 'error');
                }
            },
            
            get: () => {
                try {
                    const cached = mockStorage[MENU_CACHE_KEY];
                    if (!cached) {
                        log('No cache data found', 'warning');
                        return null;
                    }
                    
                    const { data, timestamp } = JSON.parse(cached);
                    
                    if (Date.now() - timestamp > MENU_CACHE_TIME) {
                        log('Cache data expired', 'warning');
                        delete mockStorage[MENU_CACHE_KEY];
                        return null;
                    }
                    
                    log('Cache data retrieved successfully', 'success');
                    return data;
                } catch (error) {
                    log('Error retrieving cache data: ' + error.message, 'error');
                    return null;
                }
            },
            
            clear: () => {
                delete mockStorage[MENU_CACHE_KEY];
                log('Cache cleared', 'success');
            }
        };
        
        // Helper function to log messages
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logElement.prepend(logEntry);
            console.log(`[${type}] ${message}`);
        }
        
        // Helper function to display cache data
        function displayCacheData(data) {
            const cacheDataElement = document.getElementById('cacheData');
            if (data) {
                cacheDataElement.textContent = JSON.stringify(data, null, 2);
            } else {
                cacheDataElement.textContent = 'No data available.';
            }
        }
        
        // Initialize cache with test data
        document.getElementById('initCache').addEventListener('click', () => {
            const testData = {
                categorias: [
                    { id: 'CAT_001', nombre: 'Entradas', tipo: 'principal' },
                    { id: 'CAT_002', nombre: 'Principio', tipo: 'principal' },
                    { id: 'CAT_003', nombre: 'ProteÃ­na', tipo: 'principal' }
                ],
                productosSeleccionados: [
                    { 
                        id: 'PROD_001', 
                        nombre: 'Sopa de Tomate', 
                        descripcion: 'Sopa de tomate casera',
                        categoriaId: 'CAT_001',
                        currentVersion: 1,
                        priceHistory: [],
                        versions: [],
                        stock: {
                            currentQuantity: 10,
                            minQuantity: 5,
                            maxQuantity: 100,
                            status: 'in_stock',
                            lastUpdated: new Date()
                        },
                        status: 'active',
                        metadata: {
                            createdAt: new Date(),
                            createdBy: 'system',
                            lastModified: new Date(),
                            lastModifiedBy: 'system'
                        }
                    }
                ],
                productosMenu: [
                    { 
                        id: 'PROD_002', 
                        nombre: 'Arroz Blanco', 
                        descripcion: 'Arroz blanco cocido',
                        categoriaId: 'CAT_002',
                        currentVersion: 1,
                        priceHistory: [],
                        versions: [],
                        stock: {
                            currentQuantity: 20,
                            minQuantity: 10,
                            maxQuantity: 100,
                            status: 'in_stock',
                            lastUpdated: new Date()
                        },
                        status: 'active',
                        metadata: {
                            createdAt: new Date(),
                            createdBy: 'system',
                            lastModified: new Date(),
                            lastModifiedBy: 'system'
                        }
                    }
                ],
                productosFavoritos: [],
                productosEspeciales: [],
                categoriaSeleccionada: null,
                subcategoriaSeleccionada: null,
                submenuActivo: 'menu-dia'
            };
            
            menuCacheUtils.set(testData);
            displayCacheData(testData);
        });
        
        // Get cache data
        document.getElementById('getCache').addEventListener('click', () => {
            const cacheData = menuCacheUtils.get();
            displayCacheData(cacheData);
            
            if (cacheData) {
                // Check if productosMenu is an array
                if (Array.isArray(cacheData.productosMenu)) {
                    log(`productosMenu is an array with ${cacheData.productosMenu.length} items`, 'success');
                } else {
                    log('productosMenu is NOT an array!', 'error');
                }
                
                // Check if productosSeleccionados is an array
                if (Array.isArray(cacheData.productosSeleccionados)) {
                    log(`productosSeleccionados is an array with ${cacheData.productosSeleccionados.length} items`, 'success');
                } else {
                    log('productosSeleccionados is NOT an array!', 'error');
                }
            }
        });
        
        // Clear cache
        document.getElementById('clearCache').addEventListener('click', () => {
            menuCacheUtils.clear();
            displayCacheData(null);
        });
        
        // Test productosMenu with non-array value
        document.getElementById('testProductosMenu').addEventListener('click', () => {
            const testData = {
                categorias: [
                    { id: 'CAT_001', nombre: 'Entradas', tipo: 'principal' }
                ],
                productosSeleccionados: [],
                productosMenu: {}, // This should be an array, but we're testing the fix
                productosFavoritos: [],
                productosEspeciales: [],
                categoriaSeleccionada: null,
                subcategoriaSeleccionada: null,
                submenuActivo: 'menu-dia'
            };
            
            log('Testing with productosMenu as an object instead of array', 'warning');
            menuCacheUtils.set(testData);
            
            // Get the data back to see if it was fixed
            const cacheData = menuCacheUtils.get();
            displayCacheData(cacheData);
        });
        
        // Test productosSeleccionados with non-array value
        document.getElementById('testProductosSeleccionados').addEventListener('click', () => {
            const testData = {
                categorias: [
                    { id: 'CAT_001', nombre: 'Entradas', tipo: 'principal' }
                ],
                productosSeleccionados: "not an array", // This should be an array, but we're testing the fix
                productosMenu: [],
                productosFavoritos: [],
                productosEspeciales: [],
                categoriaSeleccionada: null,
                subcategoriaSeleccionada: null,
                submenuActivo: 'menu-dia'
            };
            
            log('Testing with productosSeleccionados as a string instead of array', 'warning');
            menuCacheUtils.set(testData);
            
            // Get the data back to see if it was fixed
            const cacheData = menuCacheUtils.get();
            displayCacheData(cacheData);
        });
        
        // Initial log
        log('Menu Cache Test page loaded. Click the buttons to test functionality.', 'info');
    </script>
</body>
</html>
